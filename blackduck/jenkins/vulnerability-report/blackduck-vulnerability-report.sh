#!/bin/bash -ex

PRODUCT_PATH=${PRODUCT/::/\/}

cd ${WORKSPACE}
"${WORKSPACE}/build-tools/utilities/clean_git_clone" ssh://git@github.com/couchbaselabs/vulnerability-reviews

cd ${WORKSPACE}/build-tools/blackduck/jenkins/vulnerability-report

export LANG=en_US.UTF-8

# This script presumes that the "generate-reports" script has already been
# run, as that script populates ${WORKSPACE}/output
uv run generate-vulnerability-report.py \
    ${PRODUCT} ${VERSION} \
    -s ${WORKSPACE}/output/${PRODUCT}-${VERSION}-${BLD_NUM}-security.csv \
    -r ${WORKSPACE}/output/${PRODUCT}-${VERSION}-${BLD_NUM}-source.csv \
    -d ${WORKSPACE}/vulnerability-reviews

cd ${WORKSPACE}/vulnerability-reviews
git add ${PRODUCT_PATH}
git config push.default simple
git diff --quiet && git diff --staged --quiet || git commit \
    -m "Update report for ${PRODUCT} ${VERSION}" \
    --author='Couchbase Build Team <build-team@couchbase.com>'
if ! $SKIP_GIT_PUSH; then
    git push
fi
